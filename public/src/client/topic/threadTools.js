"use strict";define("forum/topic/threadTools",["components","translator","handleBack","api"],function(e,t,o,n){var i={};i.init=function(e,t){a(t);t.on("click",'[component="topic/delete"]',function(){l("del","/state","delete");return false});t.on("click",'[component="topic/restore"]',function(){l("put","/state","restore");return false});t.on("click",'[component="topic/purge"]',function(){l("del","","purge");return false});t.on("click",'[component="topic/lock"]',function(){l("put","/lock","lock");return false});t.on("click",'[component="topic/unlock"]',function(){l("del","/lock","unlock");return false});t.on("click",'[component="topic/pin"]',function(){l("put","/pin","pin");return false});t.on("click",'[component="topic/unpin"]',function(){l("del","/pin","unpin");return false});t.on("click",'[component="topic/mark-unread"]',function(){socket.emit("topics.markUnread",e,function(e){if(e){return app.alertError(e)}if(app.previousUrl&&!app.previousUrl.match("^/topic")){ajaxify.go(app.previousUrl,function(){o.onBackClicked(true)})}else if(ajaxify.data.category){ajaxify.go("category/"+ajaxify.data.category.slug,o.onBackClicked)}app.alertSuccess("[[topic:mark_unread.success]]")});return false});t.on("click",'[component="topic/mark-unread-for-all"]',function(){var t=$(this);socket.emit("topics.markAsUnreadForAll",[e],function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[topic:markAsUnreadForAll.success]]");t.parents(".thread-tools.open").find(".dropdown-toggle").trigger("click")});return false});t.on("click",'[component="topic/move"]',function(){require(["forum/topic/move"],function(t){t.init([e],ajaxify.data.cid)});return false});t.on("click",'[component="topic/delete/posts"]',function(){require(["forum/topic/delete-posts"],function(e){e.init()})});t.on("click",'[component="topic/fork"]',function(){require(["forum/topic/fork"],function(e){e.init()})});t.on("click",'[component="topic/move-posts"]',function(){require(["forum/topic/move-post"],function(e){e.init()})});t.on("click",'[component="topic/following"]',function(){i("follow")});t.on("click",'[component="topic/not-following"]',function(){i("follow",0)});t.on("click",'[component="topic/ignoring"]',function(){i("ignore")});function i(t,o=1){const i=o?"put":"del";n[i](`/topics/${e}/${t}`,{},()=>{var n="";if(t==="follow"){n=o?"[[topic:following_topic.message]]":"[[topic:not_following_topic.message]]"}else if(t==="ignore"){n=o?"[[topic:ignoring_topic.message]]":"[[topic:not_following_topic.message]]"}if(!o){t="unfollow"}c(t);app.alert({alert_id:"follow_thread",message:n,type:"success",timeout:5e3});$(window).trigger("action:topics.changeWatching",{tid:e,type:t})},()=>{app.alert({type:"danger",alert_id:"topic_follow",title:"[[global:please_log_in]]",message:"[[topic:login_to_subscribe]]",timeout:5e3})});return false}};function a(e){e.on("show.bs.dropdown",".thread-tools",function(){var e=$(this);var t=e.find(".dropdown-menu");if(t.html()){return}socket.emit("topics.loadTopicTools",{tid:ajaxify.data.tid,cid:ajaxify.data.cid},function(e,o){if(e){return app.alertError(e)}app.parseAndTranslate("partials/topic/topic-menu-list",o,function(e){t.html(e);$(window).trigger("action:topic.tools.load",{element:t})})})})}function l(e,t,o,a){if(!a){a=function(){}}const l=ajaxify.data.tid;const c={};const p=function(o){if(o){n[e](`/topics/${l}${t}`,c).then(a).catch(app.alertError)}};switch(o){case"delete":case"restore":case"purge":bootbox.confirm(`[[topic:thread_tools.${o}_confirm]]`,p);break;case"pin":i.requestPinExpiry(c,p.bind(null,true));break;default:p(true);break}}i.requestPinExpiry=function(e,t){app.parseAndTranslate("modals/set-pin-expiry",{},function(o){const n=bootbox.dialog({title:"[[topic:thread_tools.pin]]",message:o,onEscape:true,size:"small",buttons:{cancel:{label:"[[modules:bootbox.cancel]]",className:"btn-link"},save:{label:"[[global:save]]",className:"btn-primary",callback:function(){const o=n.get(0).querySelector("#expiry");let i=o.value;if(i===""){return t()}i=new Date(i);if(i&&i.getTime()>Date.now()){e.expiry=i.getTime();t()}else{app.alertError("[[error:invalid-date]]")}}}}})})};i.setLockedState=function(t){var o=e.get("topic");if(parseInt(t.tid,10)!==parseInt(o.attr("data-tid"),10)){return}var n=t.isLocked&&!ajaxify.data.privileges.isAdminOrMod;e.get("topic/lock").toggleClass("hidden",t.isLocked).parent().attr("hidden",t.isLocked?"":null);e.get("topic/unlock").toggleClass("hidden",!t.isLocked).parent().attr("hidden",!t.isLocked?"":null);var i=!!((t.isLocked||ajaxify.data.deleted)&&!ajaxify.data.privileges.isAdminOrMod);e.get("topic/reply/container").toggleClass("hidden",i);e.get("topic/reply/locked").toggleClass("hidden",ajaxify.data.privileges.isAdminOrMod||!t.isLocked||ajaxify.data.deleted);o.find('[component="post"]:not(.deleted) [component="post/reply"], [component="post"]:not(.deleted) [component="post/quote"]').toggleClass("hidden",i);o.find('[component="post/edit"], [component="post/delete"]').toggleClass("hidden",n);o.find('[component="post"][data-uid="'+app.user.uid+'"].deleted [component="post/tools"]').toggleClass("hidden",n);$('.topic-header [component="topic/locked"]').toggleClass("hidden",!t.isLocked);$('[component="post/tools"] .dropdown-menu').html("");ajaxify.data.locked=t.isLocked};i.setDeleteState=function(t){var o=e.get("topic");if(parseInt(t.tid,10)!==parseInt(o.attr("data-tid"),10)){return}e.get("topic/delete").toggleClass("hidden",t.isDelete).parent().attr("hidden",t.isDelete?"":null);e.get("topic/restore").toggleClass("hidden",!t.isDelete).parent().attr("hidden",!t.isDelete?"":null);e.get("topic/purge").toggleClass("hidden",!t.isDelete).parent().attr("hidden",!t.isDelete?"":null);e.get("topic/deleted/message").toggleClass("hidden",!t.isDelete);if(t.isDelete){app.parseAndTranslate("partials/topic/deleted-message",{deleter:t.user,deleted:true,deletedTimestampISO:utils.toISOString(Date.now())},function(t){e.get("topic/deleted/message").replaceWith(t);t.find(".timeago").timeago()})}var n=t.isDelete&&!ajaxify.data.privileges.isAdminOrMod;e.get("topic/reply/container").toggleClass("hidden",n);e.get("topic/reply/locked").toggleClass("hidden",ajaxify.data.privileges.isAdminOrMod||!ajaxify.data.locked||t.isDelete);o.find('[component="post"]:not(.deleted) [component="post/reply"], [component="post"]:not(.deleted) [component="post/quote"]').toggleClass("hidden",n);o.toggleClass("deleted",t.isDelete);ajaxify.data.deleted=t.isDelete?1:0};i.setPinnedState=function(t){var o=e.get("topic");if(parseInt(t.tid,10)!==parseInt(o.attr("data-tid"),10)){return}e.get("topic/pin").toggleClass("hidden",t.pinned).parent().attr("hidden",t.pinned?"":null);e.get("topic/unpin").toggleClass("hidden",!t.pinned).parent().attr("hidden",!t.pinned?"":null);var n=$('.topic-header [component="topic/pinned"]');n.toggleClass("hidden",!t.pinned);if(t.pinned){n.translateAttr("title",t.pinExpiry&&t.pinExpiryISO?"[[topic:pinned-with-expiry, "+t.pinExpiryISO+"]]":"[[topic:pinned]]")}ajaxify.data.pinned=t.pinned};function c(o){var n={follow:"[[topic:watching]]",unfollow:"[[topic:not-watching]]",ignore:"[[topic:ignoring]]"};t.translate(n[o],function(e){$('[component="topic/watch"] button').attr("title",e).tooltip("fixTitle")});var i=e.get("topic/following/menu");i.toggleClass("hidden",o!=="follow");e.get("topic/following/check").toggleClass("fa-check",o==="follow");i=e.get("topic/not-following/menu");i.toggleClass("hidden",o!=="unfollow");e.get("topic/not-following/check").toggleClass("fa-check",o==="unfollow");i=e.get("topic/ignoring/menu");i.toggleClass("hidden",o!=="ignore");e.get("topic/ignoring/check").toggleClass("fa-check",o==="ignore")}return i});
//# sourceMappingURL=threadTools.js.map