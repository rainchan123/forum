"use strict";define("forum/chats",["components","translator","mousetrap","forum/chats/recent","forum/chats/search","forum/chats/messages","benchpress","composer/autocomplete"],function(a,t,e,n,o,i,r,s){var c={initialised:false};var d=false;c.init=function(){var t=utils.findBootstrapEnvironment();if(!c.initialised){c.addSocketListeners();c.addGlobalEventListeners()}n.init();c.addEventListeners();c.resizeMainWindow();if(t==="md"||t==="lg"){c.addHotkeys()}$(document).ready(function(){$(window).trigger("action:chat.loaded",$(".chats-full"))});c.initialised=true;i.scrollToBottom($(".expanded-chat ul.chat-content"));o.init();if(ajaxify.data.hasOwnProperty("roomId")){a.get("chat/input").focus()}};c.addEventListeners=function(){c.addSendHandlers(ajaxify.data.roomId,$(".chat-input"),$('.expanded-chat button[data-action="send"]'));c.addPopoutHandler();c.addActionHandlers(a.get("chat/messages"),ajaxify.data.roomId);c.addMemberHandler(ajaxify.data.roomId,a.get("chat/controls").find('[data-action="members"]'));c.addRenameHandler(ajaxify.data.roomId,a.get("chat/controls").find('[data-action="rename"]'));c.addLeaveHandler(ajaxify.data.roomId,a.get("chat/controls").find('[data-action="leave"]'));c.addScrollHandler(ajaxify.data.roomId,ajaxify.data.uid,$(".chat-content"));c.addScrollBottomHandler($(".chat-content"));c.addCharactersLeftHandler($('[component="chat/main-wrapper"]'));c.addIPHandler($('[component="chat/main-wrapper"]'));c.createAutoComplete($('[component="chat/input"]'));$('[data-action="close"]').on("click",function(){c.switchChat()})};c.addIPHandler=function(a){a.on("click",".chat-ip-button",function(){var a=$(this).parent();var t=a.parents("[data-mid]").attr("data-mid");socket.emit("modules.chats.getIP",t,function(t,e){if(t){return app.alertError(t)}a.html(e)})})};c.addPopoutHandler=function(){$('[data-action="pop-out"]').on("click",function(){var t=a.get("chat/input").val();var e=ajaxify.data.roomId;if(app.previousUrl&&app.previousUrl.match(/chats/)){ajaxify.go("user/"+ajaxify.data.userslug+"/chats",function(){app.openChat(e,ajaxify.data.uid)},true)}else{window.history.go(-1);app.openChat(e,ajaxify.data.uid)}$(window).one("action:chat.loaded",function(){a.get("chat/input").val(t)})})};c.addScrollHandler=function(a,t,e){var n=false;e.off("scroll").on("scroll",function(){i.toggleScrollUpAlert(e);if(n){return}var o=(e[0].scrollHeight-e.height())*.1;if(e.scrollTop()>=o){return}n=true;var r=parseInt(e.children("[data-mid]").length,10);socket.emit("modules.chats.getMessages",{roomId:a,uid:t,start:r},function(a,t){if(a){return app.alertError(a.message)}if(!t){n=false;return}t=t.filter(function(a){return!$('[component="chat/message"][data-mid="'+a.messageId+'"]').length});if(!t.length){n=false;return}i.parseMessage(t,function(a){var t=e.scrollTop();var o=e[0].scrollHeight;a=$(a);e.prepend(a);a.find(".timeago").timeago();a.find("img:not(.not-responsive)").addClass("img-responsive");e.scrollTop(e[0].scrollHeight-o+t);n=false})})})};c.addScrollBottomHandler=function(a){a.parent().find('[component="chat/messages/scroll-up-alert"]').off("click").on("click",function(){i.scrollToBottom(a)})};c.addCharactersLeftHandler=function(a){var t=a.find('[component="chat/input"]');t.on("change keyup paste",function(){i.updateRemainingLength(a)})};c.addActionHandlers=function(a,t){a.on("click","[data-action]",function(){var a=$(this).parents("[data-mid]").attr("data-mid");var e=this.getAttribute("data-action");switch(e){case"edit":var n=$('[data-roomid="'+t+'"] [component="chat/input"]');i.prepEdit(n,a,t);break;case"delete":i.delete(a,t);break;case"restore":i.restore(a,t);break}})};c.addHotkeys=function(){e.bind("ctrl+up",function(){var a=$(".chats-list .bg-info");var t=a.prev();if(t.length){c.switchChat(t.attr("data-roomid"))}});e.bind("ctrl+down",function(){var a=$(".chats-list .bg-info");var t=a.next();if(t.length){c.switchChat(t.attr("data-roomid"))}});e.bind("up",function(t){if(t.target===a.get("chat/input").get(0)){var e=a.get("chat/messages").find('.chat-message[data-self="1"]').last();if(!e.length){return}var n=e.attr("data-mid");var o=a.get("chat/input");i.prepEdit(o,n,ajaxify.data.roomId)}})};c.addMemberHandler=function(a,t){var e;t.on("click",function(){app.parseAndTranslate("partials/modals/manage_room",{},function(t){e=bootbox.dialog({title:"[[modules:chat.manage-room]]",message:t});e.attr("component","chat/manage-modal");c.refreshParticipantsList(a,e);c.addKickHandler(a,e);var n=e.find("input");var o=e.find(".text-danger");require(["autocomplete","translator"],function(t,i){t.user(n,function(t,r){o.text("");socket.emit("modules.chats.addUserToRoom",{roomId:a,username:r.item.user.name},function(t){if(t){i.translate(t.message,function(a){o.text(a)})}c.refreshParticipantsList(a,e);n.val("")})})})})})};c.addKickHandler=function(a,t){t.on("click",'[data-action="kick"]',function(){var e=parseInt(this.getAttribute("data-uid"),10);socket.emit("modules.chats.removeUserFromRoom",{roomId:a,uid:e},function(e){if(e){return app.alertError(e.message)}c.refreshParticipantsList(a,t)})})};c.addLeaveHandler=function(a,t){t.on("click",function(){bootbox.confirm({size:"small",title:"[[modules:chat.leave]]",message:'<p>[[modules:chat.leave-prompt]]</p><p class="help-block">[[modules:chat.leave-help]]</p>',callback:function(e){if(e){socket.emit("modules.chats.leave",a,function(a){if(a){app.alertError(a.message)}var e=t.parents(".chat-modal");if(e.length){require(["chat"],function(a){a.close(e)})}else{ajaxify.go("chats")}})}}})})};c.refreshParticipantsList=function(a,e){socket.emit("modules.chats.getUsersInRoom",{roomId:a},function(a,n){var o=e.find(".list-group");if(a){return t.translate("[[error:invalid-data]]",function(a){o.find("li").text(a)})}app.parseAndTranslate("partials/modals/manage_room_users",{users:n},function(a){o.html(a)})})};c.addRenameHandler=function(a,t,e){var n;t.on("click",function(){app.parseAndTranslate("partials/modals/rename_room",{name:e||ajaxify.data.roomName},function(a){n=bootbox.dialog({title:"[[modules:chat.rename-room]]",message:a,buttons:{save:{label:"[[global:save]]",className:"btn-primary",callback:o}}})})});function o(){socket.emit("modules.chats.renameRoom",{roomId:a,newName:n.find("#roomName").val()},function(a){if(a){return app.alertError(a.message)}})}};c.addSendHandlers=function(a,t,e){t.off("keypress").on("keypress",function(e){if(e.which===13&&!e.shiftKey){i.sendMessage(a,t);return false}});e.off("click").on("click",function(){i.sendMessage(a,t);t.focus();return false})};c.createAutoComplete=function(a){if(!a.length){return}var t={element:a,strategies:[],options:{style:{"z-index":2e4,flex:0,top:"inherit"},placement:"top"}};$(window).trigger("chat:autocomplete:init",t);if(t.strategies.length){s.setup(t)}};c.leave=function(a){var t=a.attr("data-roomid");socket.emit("modules.chats.leave",t,function(e){if(e){return app.alertError(e.message)}if(parseInt(t,10)===parseInt(ajaxify.data.roomId,10)){ajaxify.go("user/"+ajaxify.data.userslug+"/chats")}else{a.remove()}require(["chat"],function(a){var e=a.getModal(t);if(e.length){a.close(e)}})})};c.switchChat=function(t){if(!t){t=""}var e="user/"+ajaxify.data.userslug+"/chats/"+t;if(self.fetch){fetch(config.relative_path+"/api/"+e,{credentials:"include"}).then(function(t){if(t.ok){t.json().then(function(t){app.parseAndTranslate("partials/chats/message-window",t,function(n){a.get("chat/main-wrapper").html(n);n.find(".timeago").timeago();c.resizeMainWindow();ajaxify.data=t;c.setActive();c.addEventListeners();$(window).trigger("action:chat.loaded",$(".chats-full"));i.scrollToBottom($(".expanded-chat ul.chat-content"));if(history.pushState){history.pushState({url:e},null,window.location.protocol+"//"+window.location.host+config.relative_path+"/"+e)}})})}else{console.warn("[search] Received "+t.status)}}).catch(function(a){console.warn("[search] "+a.message)})}else{ajaxify.go(e)}};c.addGlobalEventListeners=function(){$(window).on("resize",c.resizeMainWindow);$(window).on("mousemove keypress click",function(){if(d&&ajaxify.data.roomId){socket.emit("modules.chats.markRead",ajaxify.data.roomId);d=false}})};c.addSocketListeners=function(){socket.on("event:chats.receive",function(t){if(parseInt(t.roomId,10)===parseInt(ajaxify.data.roomId,10)){d=t.self===0;t.message.self=t.self;i.appendChatMessage($(".expanded-chat .chat-content"),t.message)}else if(ajaxify.data.template.chats){var e=$("[data-roomid="+t.roomId+"]");if(e.length>0){e.addClass("unread")}else{var n=a.get("chat/recent");app.parseAndTranslate("partials/chats/recent_room",{rooms:{roomId:t.roomId,lastUser:t.message.fromUser,usernames:t.message.fromUser.username,unread:true}},function(a){n.prepend(a)})}}});socket.on("event:user_status_change",function(a){app.updateUserStatus($('.chats-list [data-uid="'+a.uid+'"] [component="user/status"]'),a.status)});i.addSocketListeners();socket.on("event:chats.roomRename",function(t){var e=a.get("chat/recent/room",t.roomId);var n=e.find('[component="chat/title"]');ajaxify.data.roomName=t.newName;n.text(t.newName)})};c.resizeMainWindow=function(){var t=$(window).height();var e=a.get("chat/main-wrapper");var n=a.get("chat/nav-wrapper");var o=0;if(e.length&&n.length){o=e.offset().top||n.offset().top}$(".chats-full").height(t-o-1);c.setActive()};c.setActive=function(){if(ajaxify.data.roomId){socket.emit("modules.chats.markRead",ajaxify.data.roomId);$('[data-roomid="'+ajaxify.data.roomId+'"]').toggleClass("unread",false);$('.expanded-chat [component="chat/input"]').focus()}$(".chats-list li").removeClass("bg-info");$('.chats-list li[data-roomid="'+ajaxify.data.roomId+'"]').addClass("bg-info");a.get("chat/nav-wrapper").attr("data-loaded",ajaxify.data.roomId?"1":"0")};return c});
//# sourceMappingURL=chats.js.map