"use strict";define("pictureCropper",["cropper"],function(e){var a={};a.show=function(e,a){var i=e.hasOwnProperty("fileSize")&&e.fileSize!==undefined?parseInt(e.fileSize,10):false;app.parseAndTranslate("partials/modals/upload_file_modal",{showHelp:e.hasOwnProperty("showHelp")&&e.showHelp!==undefined?e.showHelp:true,fileSize:i,title:e.title||"[[global:upload_file]]",description:e.description||"",button:e.button||"[[global:upload]]",accept:e.accept?e.accept.replace(/,/g,"&#44; "):""},function(i){i.modal("show");i.on("hidden.bs.modal",function(){i.remove()});var r=i.find("#uploadForm");if(e.route){r.attr("action",e.route)}i.find("#fileUploadSubmitBtn").on("click",function(){$(this).addClass("disabled");e.uploadModal=i;t(e,a);return false})})};a.handleImageCrop=function(a,t){$("#crop-picture-modal").remove();app.parseAndTranslate("modals/crop_picture",{url:utils.escapeHTML(a.url)},function(o){o.modal({backdrop:"static"}).modal("show");var n=parseInt($(window).height()/2,10);var s=document.getElementById("cropped-image");$(s).css("max-height",n);var d=new e(s,{aspectRatio:a.aspectRatio,autoCropArea:1,viewMode:1,checkCrossOrigin:true,cropmove:function(){if(a.restrictImageDimension){if(d.cropBoxData.width>a.imageDimension){d.setCropBoxData({width:a.imageDimension})}if(d.cropBoxData.height>a.imageDimension){d.setCropBoxData({height:a.imageDimension})}}},ready:function(){if(!r(d,a)){return o.modal("hide")}if(a.restrictImageDimension){var n=s.width<s.height?s.width:s.height;var l=n>a.imageDimension?a.imageDimension:n;d.setCropBoxData({width:l,height:l})}o.find(".rotate").on("click",function(){var e=this.getAttribute("data-degrees");d.rotate(e)});o.find(".flip").on("click",function(){var e=this.getAttribute("data-option");var a=this.getAttribute("data-method");if(a==="scaleX"){d.scaleX(e)}else{d.scaleY(e)}this.setAttribute("data-option",e*-1)});o.find(".reset").on("click",function(){d.reset()});o.find(".crop-btn").on("click",function(){$(this).addClass("disabled");var e=r(d,a);if(!e){return}o.find("#upload-progress-bar").css("width","0%");o.find("#upload-progress-box").show().removeClass("hide");i({data:a,imageData:e,progressBarEl:o.find("#upload-progress-bar")},function(e,a){if(e){o.find("#upload-progress-box").hide();o.find(".upload-btn").removeClass("disabled");o.find(".crop-btn").removeClass("disabled");return app.alertError(e.message)}t(a.url);o.modal("hide")})});o.find(".upload-btn").on("click",function(){$(this).addClass("disabled");d.destroy();d=new e(s,{viewMode:1,autoCropArea:1,ready:function(){o.find(".crop-btn").trigger("click")}})})}})})};function i(e,a){var i={};i[e.data.paramName]=e.data.paramValue;i.method=e.data.socketMethod;i.size=e.imageData.length;i.progress=0;var r=1e5;function t(){var o=e.imageData.slice(i.progress,i.progress+r);socket.emit("uploads.upload",{chunk:o,params:i},function(n,s){if(n){return app.alertError(n)}if(i.progress+r<i.size){i.progress+=o.length;e.progressBarEl.css("width",(i.progress/i.size*100).toFixed(2)+"%");return setTimeout(t,100)}e.progressBarEl.css("width","100%");a(null,s)})}t()}function r(e,a){var i;try{i=a.imageType?e.getCroppedCanvas().toDataURL(a.imageType):e.getCroppedCanvas().toDataURL()}catch(e){var r=["The operation is insecure.","Failed to execute 'toDataURL' on 'HTMLCanvasElement': Tainted canvases may not be exported."];if(r.indexOf(e.message)!==-1){app.alertError("[[error:cors-error]]")}else{app.alertError(e.message)}return}return i}function t(e,i){function r(a,i){if(a==="error"){e.uploadModal.find("#fileUploadSubmitBtn").removeClass("disabled")}e.uploadModal.find("#alert-"+a).translateText(i).removeClass("hide")}var t=e.uploadModal.find("#fileInput");if(!t.val()){return r("error","[[uploads:select-file-to-upload]]")}var o=t[0].files[0];var n=e.hasOwnProperty("fileSize")&&e.fileSize!==undefined?parseInt(e.fileSize,10):false;if(n&&o.size>n*1024){return r("error","[[error:file-too-big, "+n+"]]")}if(o.name.endsWith(".gif")){require(["uploader"],function(a){a.ajaxSubmit(e.uploadModal,i)});return}var s=new FileReader;s.addEventListener("load",function(){var r=s.result;e.uploadModal.modal("hide");a.handleImageCrop({url:r,imageType:o.type,socketMethod:e.socketMethod,aspectRatio:e.aspectRatio,allowSkippingCrop:e.allowSkippingCrop,restrictImageDimension:e.restrictImageDimension,imageDimension:e.imageDimension,paramName:e.paramName,paramValue:e.paramValue},i)},false);if(o){s.readAsDataURL(o)}}return a});
//# sourceMappingURL=pictureCropper.js.map