"use strict";define("chat",["components","taskbar","translator"],function(t,a,e){var o={};var i=false;o.loadChatsDropdown=function(t){socket.emit("modules.chats.getRecentChats",{uid:app.user.uid,after:0},function(a,o){if(a){return app.alertError(a.message)}var i=o.rooms.filter(function(t){return t.teaser});e.toggleTimeagoShorthand(function(){for(var a=0;a<i.length;a+=1){i[a].teaser.timeago=$.timeago(new Date(parseInt(i[a].teaser.timestamp,10)))}e.toggleTimeagoShorthand();app.parseAndTranslate("partials/chats/dropdown",{rooms:i},function(a){t.find("*").not(".navigation-link").remove();t.prepend(a);app.createUserTooltips(t,"right");t.off("click").on("click","[data-roomid]",function(t){if($(t.target).parents(".user-link").length){return}var a=$(this).attr("data-roomid");if(!ajaxify.currentPage.match(/^chats\//)){app.openChat(a)}else{ajaxify.go("user/"+app.user.userslug+"/chats/"+a)}});$('[component="chats/mark-all-read"]').off("click").on("click",function(){socket.emit("modules.chats.markAllRead",function(t){if(t){return app.alertError(t)}})})})})})};o.onChatMessageReceived=function(t){var a=t.self===1;t.message.self=t.self;i=t.self===0;if(o.modalExists(t.roomId)){n(t)}else if(!ajaxify.data.template.chats){socket.emit("modules.chats.loadRoom",{roomId:t.roomId},function(t,e){if(t){return app.alertError(t.message)}e.users=e.users.filter(function(t){return t&&parseInt(t.uid,10)!==parseInt(app.user.uid,10)});e.silent=true;e.uid=app.user.uid;e.isSelf=a;o.createModal(e)})}};function n(t){var e=o.getModal(t.roomId);var i=t.message.fromUser.username;var n=t.self===1;require(["forum/chats/messages"],function(r){if(!e.find('[data-mid="'+t.message.messageId+'"]').length){r.appendChatMessage(e.find(".chat-content"),t.message)}if(e.is(":visible")){a.updateActive(e.attr("data-uuid"));if(r.isAtBottom(e.find(".chat-content"))){r.scrollToBottom(e.find(".chat-content"))}}else if(!ajaxify.data.template.chats){o.toggleNew(e.attr("data-uuid"),true,true)}if(!n&&(!e.is(":visible")||!app.isFocused)){a.push("chat",e.attr("data-uuid"),{title:"[[modules:chat.chatting_with]] "+(t.roomName||i),touid:t.message.fromUser.uid,roomId:t.roomId,isSelf:false})}})}o.onUserStatusChange=function(t){var a=o.getModal(t.uid);app.updateUserStatus(a.find('[component="user/status"]'),t.status)};o.onRoomRename=function(t){var e=$("<div></div>").html(t.newName).text();var i=o.getModal(t.roomId);i.find('[component="chat/room/name"]').text(e);a.update("chat",i.attr("data-uuid"),{title:e});$(window).trigger("action:chat.renamed",Object.assign(t,{modal:i}))};o.getModal=function(t){return $("#chat-modal-"+t)};o.modalExists=function(t){return $("#chat-modal-"+t).length!==0};o.createModal=function(e,n){n=n||function(){};require(["scrollStop","forum/chats","forum/chats/messages"],function(r,d,s){app.parseAndTranslate("chat",e,function(c){if(o.modalExists(e.roomId)){return n(o.getModal(e.roomId))}var l=utils.generateUUID();var u=false;c.attr("id","chat-modal-"+e.roomId);c.attr("data-roomid",e.roomId);c.attr("intervalId",0);c.attr("data-uuid",l);c.css("position","fixed");c.appendTo($("body"));c.find(".timeago").timeago();o.center(c);app.loadJQueryUI(function(){c.find(".modal-content").resizable({handles:"n, e, s, w, se",minHeight:250,minWidth:400});c.find(".modal-content").on("resize",function(t,a){if(a.originalSize.height===a.size.height){return}c.find(".modal-body").css("height",o.calculateChatListHeight(c))});c.draggable({start:function(){a.updateActive(l)},stop:function(){c.find("#chat-message-input").focus()},distance:10,handle:".modal-header"})});r.apply(c.find('[component="chat/messages"]'));c.find("#chat-close-btn").on("click",function(){o.close(c)});function m(){var a=t.get("chat/input").val();$(window).one("action:ajaxify.end",function(){t.get("chat/input").val(a)});ajaxify.go("user/"+app.user.userslug+"/chats/"+c.attr("data-roomid"));o.close(c)}c.find(".modal-header").on("dblclick",m);c.find('button[data-action="maximize"]').on("click",m);c.find('button[data-action="minimize"]').on("click",function(){var t=c.attr("data-uuid");o.minimize(t)});c.on("click",":not(.close)",function(){a.updateActive(c.attr("data-uuid"));if(u){u=false}});c.on("mousemove",function(t){if(t.which===1){u=true}});c.on("mousemove keypress click",function(){if(i){socket.emit("modules.chats.markRead",e.roomId);i=false}});d.addActionHandlers(c.find('[component="chat/messages"]'),e.roomId);d.addRenameHandler(c.attr("data-roomid"),c.find('[data-action="rename"]'),e.roomName);d.addLeaveHandler(c.attr("data-roomid"),c.find('[data-action="leave"]'));d.addSendHandlers(c.attr("data-roomid"),c.find(".chat-input"),c.find('[data-action="send"]'));d.addMemberHandler(c.attr("data-roomid"),c.find('[data-action="members"]'));d.createAutoComplete(c.find('[component="chat/input"]'));d.addScrollHandler(c.attr("data-roomid"),e.uid,c.find(".chat-content"));d.addScrollBottomHandler(c.find(".chat-content"));d.addCharactersLeftHandler(c);d.addIPHandler(c);s.addSocketListeners();a.push("chat",c.attr("data-uuid"),{title:"[[modules:chat.chatting_with]] "+(e.roomName||(e.users.length?e.users[0].username:"")),roomId:e.roomId,icon:"fa-comment",state:"",isSelf:e.isSelf},function(){a.toggleNew(c.attr("data-uuid"),!e.isSelf);$(window).trigger("action:chat.loaded",c);if(typeof n==="function"){n(c)}})})})};o.focusInput=function(t){t.find('[component="chat/input"]').focus()};o.close=function(t){var e=t.attr("data-uuid");clearInterval(t.attr("intervalId"));t.attr("intervalId",0);t.remove();t.data("modal",null);a.discard("chat",e);if(t.attr("data-mobile")){o.disableMobileBehaviour(t)}$(window).trigger("action:chat.closed",{uuid:e,modal:t})};o.closeByUUID=function(t){var a=$('.chat-modal[data-uuid="'+t+'"]');o.close(a)};o.center=function(t){var a=false;if(t.hasClass("hide")){t.removeClass("hide");a=true}t.css("left",Math.max(0,($(window).width()-$(t).outerWidth())/2+$(window).scrollLeft())+"px");t.css("top",Math.max(0,$(window).height()/2-$(t).outerHeight()/2)+"px");if(a){t.addClass("hide")}return t};o.load=function(t){require(["forum/chats/messages"],function(e){var i=$('.chat-modal[data-uuid="'+t+'"]');i.removeClass("hide");a.updateActive(t);e.scrollToBottom(i.find(".chat-content"));o.focusInput(i);socket.emit("modules.chats.markRead",i.attr("data-roomid"));var n=utils.findBootstrapEnvironment();if(n==="xs"||n==="sm"){o.enableMobileBehaviour(i)}})};o.enableMobileBehaviour=function(t){app.toggleNavbar(false);t.attr("data-mobile","1");var a=t.find(".modal-body");a.css("height",o.calculateChatListHeight(t));function e(){a.css("height",o.calculateChatListHeight(t));require(["forum/chats/messages"],function(a){a.scrollToBottom(t.find(".chat-content"))})}$(window).on("resize",e);$(window).one("action:ajaxify.start",function(){o.close(t);$(window).off("resize",e)})};o.disableMobileBehaviour=function(){app.toggleNavbar(true)};o.calculateChatListHeight=function(t){return t.find(".modal-content").outerHeight()-t.find(".modal-header").outerHeight()};o.minimize=function(t){var e=$('.chat-modal[data-uuid="'+t+'"]');e.addClass("hide");a.minimize("chat",t);clearInterval(e.attr("intervalId"));e.attr("intervalId",0);$(window).trigger("action:chat.minimized",{uuid:t,modal:e})};o.toggleNew=a.toggleNew;return o});
//# sourceMappingURL=chat.js.map