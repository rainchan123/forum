"use strict";define("search",["navigator","translator","storage"],function(e,t,r){var i={current:{}};i.query=function(e,t){var r=e.term.match(/^in:topic-([\d]+) /);t=t||function(){};if(!r){ajaxify.go("search?"+n(e));t()}else{var a=e.term.replace(r[0],"");var c=r[1];if(a.length>0){i.queryTopic(c,a,t)}}};i.api=function(e,t){var r=config.relative_path+"/api/search?"+n(e);e.searchOnly=undefined;var i=config.relative_path+"/search?"+n(e);$.get(r,function(e){e.url=i;t(e)})};function n(e){var t=e.in||"titlesposts";var r=e.by||"";var i=e.term.replace(/^[ ?#]*/,"");try{i=encodeURIComponent(i)}catch(e){return app.alertError("[[error:invalid-search-term]]")}var n={term:i,in:t};if(e.matchWords){n.matchWords=e.matchWords}if(r&&r.length&&(t==="posts"||t==="titles"||t==="titlesposts")){n.by=r}if(e.categories&&e.categories.length){n.categories=e.categories;if(e.searchChildren){n.searchChildren=e.searchChildren}}if(e.hasTags&&e.hasTags.length){n.hasTags=e.hasTags}if(parseInt(e.replies,10)>0){n.replies=e.replies;n.repliesFilter=e.repliesFilter||"atleast"}if(e.timeRange){n.timeRange=e.timeRange;n.timeFilter=e.timeFilter||"newer"}if(e.sortBy){n.sortBy=e.sortBy;n.sortDirection=e.sortDirection}if(e.showAs){n.showAs=e.showAs}if(e.searchOnly){n.searchOnly=e.searchOnly}$(window).trigger("action:search.createQueryString",{query:n,data:e});return decodeURIComponent($.param(n))}i.getSearchPreferences=function(){try{return JSON.parse(r.getItem("search-preferences")||"{}")}catch(e){return{}}};i.highlightMatches=function(e,t){if(!e||!t.length){return}e=utils.escapeHTML(e.replace(/^"/,"").replace(/"$/,"").trim());var r=e.split(" ").map(function(e){return utils.escapeRegexChars(e)}).join("|");var i=new RegExp("("+r+")","gi");t.each(function(){var e=$(this);var t=[];e.find("*").each(function(){$(this).after("\x3c!-- "+t.length+" --\x3e");t.push($("<div></div>").append($(this)))});e.html(e.html().replace(i,function(e,t){return'<strong class="search-match">'+t+"</strong>"}));t.forEach(function(t,r){e.html(e.html().replace("\x3c!-- "+r+" --\x3e",function(){return t.html()}))})});$(".search-result-text").find("img:not(.not-responsive)").addClass("img-responsive")};i.queryTopic=function(e,t){socket.emit("topics.search",{tid:e,term:t},function(r,n){if(r){return app.alertError(r.message)}if(Array.isArray(n)){i.current={results:n.sort(function(e,t){return e-t}),tid:e,term:t};i.checkPagePresence(e,function(){i.topicDOM.update(0)})}})};i.checkPagePresence=function(e,t){if(parseInt(ajaxify.data.tid,10)!==parseInt(e,10)){ajaxify.go("topic/"+e,t)}else{t()}};i.topicDOM={active:false};i.topicDOM.prev=function(){i.topicDOM.update(i.current.index===0?i.current.results.length-1:i.current.index-1)};i.topicDOM.next=function(){i.topicDOM.update(i.current.index===i.current.results.length-1?0:i.current.index+1)};i.topicDOM.update=function(r){var n=$(".topic-search");i.current.index=r;i.topicDOM.start();if(i.current.results.length>0){n.find(".count").html(r+1+" / "+i.current.results.length);n.find(".prev, .next").removeAttr("disabled");var a={pid:i.current.results[r],tid:i.current.tid,topicPostSort:config.topicPostSort};socket.emit("posts.getPidIndex",a,function(t,r){if(t){return app.alertError(t.message)}e.scrollToIndex(r,true)})}else{t.translate("[[search:no-matches]]",function(e){n.find(".count").html(e)});n.removeClass("hidden").find(".prev, .next").attr("disabled","disabled")}};i.topicDOM.start=function(){$(".topic-search").removeClass("hidden");if(!i.topicDOM.active){i.topicDOM.active=true;require(["mousetrap"],function(e){e.bind("esc",i.topicDOM.end)})}};i.topicDOM.end=function(){$(".topic-search").addClass("hidden").find(".prev, .next").attr("disabled","disabled");i.topicDOM.active=false;require(["mousetrap"],function(e){e.unbind("esc",i.topicDOM.end)})};return i});
//# sourceMappingURL=search.js.map