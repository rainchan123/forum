"use strict";(function(e){function t(e,t){return Promise.resolve(jQuery.getJSON([config.assetBaseUrl,"language",e,t].join("/")+".json?"+config["cache-buster"]))}var r=function(){console.warn.apply(console,arguments)};if(typeof define==="function"&&define.amd){define("translator",[],function(){return e(utils,t,r)})}else if(typeof module==="object"&&module.exports){(function(){var t=require("../../../src/languages");if(global.env==="development"){var n=require("winston");r=function(e){n.warn(e)}}module.exports=e(require("../utils"),t.get,r)})()}})(function(e,t,r){var n=Object.assign||jQuery.extend;function a(t){return e.escapeHTML(e.decodeHTMLEntities(String(t).replace(/[\s\xa0]+/g," ").replace(/^\s+|\s+$/g,"")))}var i=function(){function n(e){var t=this;if(!e){throw new TypeError("Parameter `language` must be a language string. Received "+e+(e===""?"(empty string)":""))}t.modules=Object.keys(n.moduleFactories).map(function(t){var r=n.moduleFactories[t];return[t,r(e)]}).reduce(function(e,t){var r=t[0];var n=t[1];e[r]=n;return e},{});t.lang=e;t.translations={}}n.prototype.load=t;n.prototype.translate=function e(t){var r="a-zA-Z0-9\\-_.\\/";var n=new RegExp("["+r+"]");var a=new RegExp("[^"+r+"\\]]");var i=0;var s=0;var o=t.length;var l=[];var u=false;function c(e){var t=e.length;var r=[];var n=0;var a=0;var i=0;while(n+2<=t){if(e[n]==="["&&e[n+1]==="["){i+=1;n+=1}else if(e[n]==="]"&&e[n+1]==="]"){i-=1;n+=1}else if(i===0&&e[n]===","&&e[n-1]!=="\\"){r.push(e.slice(a,n).trim());n+=1;a=n}n+=1}r.push(e.slice(a,n+1).trim());return r}i=t.indexOf("[[",i);while(i+2<=o&&i!==-1){l.push(t.slice(s,i));i+=2;s=i;u=true;var f=0;var g;var p;var v=false;var h=false;var m=false;var d=false;while(i+2<=o){g=t[i];p=t[i+1];if(!v&&n.test(g)){v=true;i+=1}else if(v&&!h&&g===":"){h=true;i+=1}else if(h&&!m&&n.test(g)){m=true;i+=1}else if(m&&!d&&g===","){d=true;i+=1}else if(!(v&&h&&m&&d)&&a.test(g)){i+=1;s-=2;u=false;if(f>0){f-=1}else{break}}else if(g==="["&&p==="["){f+=1;i+=2}else if(g==="]"&&p==="]"){if(f===0){var y=t.slice(s,i);var b=c(y);var j=b[0];var w=b.slice(1);var T="";if(w&&w.length){T=this.translate(y)}l.push(this.translateKey(j,w,T));i+=2;s=i;u=false;break}f-=1;i+=2}else{i+=1}}i=t.indexOf("[[",i)}var q=t.slice(s);if(u){q=this.translate(q)}l.push(q);return Promise.all(l).then(function(e){return e.join("")})};n.prototype.translateKey=function e(t,n,i){var s=this;var o=t.split(":",2);var l=o[0];var u=o[1];if(s.modules[l]){return Promise.resolve(s.modules[l](u,n))}if(l&&o.length===1){return Promise.resolve("[["+l+"]]")}if(l&&!u){r('Missing key in translation token "'+t+'" for language "'+s.lang+'"');return Promise.resolve("[["+l+"]]")}var c=this.getTranslation(l,u);return c.then(function(e){if(!e){r('Missing translation "'+t+'" for language "'+s.lang+'"');return i||u}var o=n.map(function(e){return s.translate(a(e))});return Promise.all(o).then(function(t){var r=e;t.forEach(function(e,t){var n=e.replace(/%(?=\d)/g,"&#37;").replace(/\\,/g,"&#44;");n=n.replace(/&amp;lsqb;/g,"&lsqb;").replace(/&amp;rsqb;/g,"&rsqb;");r=r.replace(new RegExp("%"+(t+1),"g"),n)});return r})})};n.prototype.getTranslation=function e(t,n){var a;if(!t){r("[translator] Parameter `namespace` is "+t+(t===""?"(empty string)":""));a=Promise.resolve({})}else{this.translations[t]=this.translations[t]||this.load(this.lang,t).catch(function(){return{}});a=this.translations[t]}if(n){return a.then(function(e){if(typeof e[n]==="string")return e[n];const t=n.split(".");for(let r=0;r<=t.length;r++){if(r===t.length){return e[t[r-1]]!==undefined?e[t[r-1]]:e[""]}switch(typeof e[t[r]]){case"object":e=e[t[r]];break;case"string":if(r===t.length-1){return e[t[r]]}return false;default:return false}}})}return a};function i(e){var t=[];function r(e){if(e.nodeType===3){t.push(e)}else{for(var n=0,a=e.childNodes,i=a.length;n<i;n+=1){r(a[n])}}}r(e);return t}n.prototype.translateInPlace=function t(r,n){n=n||["placeholder","title"];var a=i(r);var s=a.map(function(t){return e.escapeHTML(t.nodeValue)}).join("  ||  ");var o=n.reduce(function(e,t){var n=Array.prototype.map.call(r.querySelectorAll("["+t+'*="[["]'),function(e){return[t,e]});return e.concat(n)},[]);var l=o.map(function(e){return e[1].getAttribute(e[0])}).join("  ||  ");return Promise.all([this.translate(s),this.translate(l)]).then(function(e){var t=e[0];var r=e[1];if(t){t.split("  ||  ").forEach(function(e,t){$(a[t]).replaceWith(e)})}if(r){r.split("  ||  ").forEach(function(e,t){o[t][1].setAttribute(o[t][0],e)})}})};n.getLanguage=function t(){var r;if(typeof window==="object"&&window.config&&window.utils){r=e.params().lang||config.userLang||config.defaultLang||"en-GB"}else{var n=require("../../../src/meta");r=n.config&&n.config.defaultLang?n.config.defaultLang:"en-GB"}return r};n.create=function e(t){if(!t){t=n.getLanguage()}n.cache[t]=n.cache[t]||new n(t);return n.cache[t]};n.cache={};n.registerModule=function e(t,r){n.moduleFactories[t]=r;Object.keys(n.cache).forEach(function(e){var a=n.cache[e];a.modules[t]=r(a.lang)})};n.moduleFactories={};n.removePatterns=function e(t){var r=t.length;var n=0;var a=0;var i=0;var s="";var o;while(n<r){o=t.slice(n,n+2);if(o==="[["){if(i===0){s+=t.slice(a,n)}i+=1;n+=2}else if(o==="]]"){i-=1;n+=2;if(i===0){a=n}}else{n+=1}}s+=t.slice(a,n);return s};n.escape=function e(t){return typeof t==="string"?t.replace(/\[\[/g,"&lsqb;&lsqb;").replace(/\]\]/g,"&rsqb;&rsqb;"):t};n.unescape=function e(t){return typeof t==="string"?t.replace(/&lsqb;/g,"[").replace(/\\\[/g,"[").replace(/&rsqb;/g,"]").replace(/\\\]/g,"]"):t};n.compile=function e(){var t=Array.prototype.slice.call(arguments,0).map(function(e){return String(e).replace(/%/g,"&#37;").replace(/,/g,"&#44;")});return"[["+t.join(", ")+"]]"};return n}();var s={Translator:i,compile:i.compile,escape:i.escape,unescape:i.unescape,getLanguage:i.getLanguage,flush:function(){Object.keys(i.cache).forEach(function(e){i.cache[e].translations={}})},translate:function e(t,n,a){var s=a;var o=n;if(typeof n==="function"){s=n;o=null}if(!(typeof t==="string"||t instanceof String)||t===""){if(s){return setTimeout(s,0,"")}return""}return i.create(o).translate(t).then(function(e){if(s){setTimeout(s,0,e)}return e},function(e){r("Translation failed: "+e.stack)})},addTranslation:function e(t,r,a){i.create(t).getTranslation(r).then(function(e){n(e,a)})},getTranslations:function e(t,r,n){n=n||function(){};i.create(t).getTranslation(r).then(n)},load:function e(t,r,n){s.getTranslations(t,r,n)},toggleTimeagoShorthand:function t(r){function a(){var e=n({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=n({},s.timeagoShort);s.timeagoShort=n({},e);if(typeof r==="function"){r()}}if(!s.timeagoShort){var i=e.userLangToTimeagoCode(config.userLang);if(!config.timeagoCodes.includes(i+"-short")){i="en"}var o=n({},jQuery.timeago.settings.strings);s.switchTimeagoLanguage(i+"-short",function(){s.timeagoShort=n({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=n({},o);a()})}else{a()}},switchTimeagoLanguage:function e(t,r){delete s.timeagoShort;var n="timeago/locales/jquery.timeago."+t;require.undef(n);require([n],function(){r()})},prepareDOM:function e(){s.translate("[[language:dir]]",function(e){if(e&&!$("html").attr("data-dir")){jQuery("html").css("direction",e).attr("data-dir",e)}})}};return s});
//# sourceMappingURL=translator.js.map