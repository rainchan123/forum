"use strict";define("admin/manage/users",["translator","benchpress","autocomplete","api","slugify","bootbox","accounts/invite"],function(e,a,r,n,t,s,i){var o={};o.init=function(){$("#results-per-page").val(ajaxify.data.resultsPerPage).on("change",function(){var e=utils.params();e.resultsPerPage=$("#results-per-page").val();var a=d(e);ajaxify.go(window.location.pathname+"?"+a)});$(".export-csv").on("click",function(){socket.once("event:export-users-csv",function(){app.removeAlert("export-users-start");app.alert({alert_id:"export-users",type:"success",title:"[[global:alert.success]]",message:"[[admin/manage/users:export-users-completed]]",clickfn:function(){window.location.href=config.relative_path+"/api/admin/users/csv"},timeout:0})});socket.emit("admin.user.exportUsersCSV",{},function(e){if(e){return app.alertError(e)}app.alert({alert_id:"export-users-start",message:"[[admin/manage/users:export-users-started]]",timeout:ajaxify.data.userCount/5e3*500})});return false});function o(){var e=[];$('.users-table [component="user/select/single"]').each(function(){if($(this).is(":checked")){e.push($(this).attr("data-uid"))}});return e}function c(e,a){$('.users-table [component="user/select/single"]:checked').parents(".user-row").find(e).each(function(){$(this).toggleClass("hidden",!a)})}function l(){$('.users-table [component="user/select/single"]').prop("checked",false);$('.users-table [component="user/select/all"]').prop("checked",false)}function f(e){const a=document.querySelector(`.users-table [component="user/select/single"][data-uid="${e}"]`);if(a){const e=a.closest(".user-row");e.parentNode.removeChild(e)}}function g(e,a,r){return function(n){if(n){return app.alertError(n.message)}app.alertSuccess(e);if(a){c(a,r)}l()}}function h(e,a,r){app.alertSuccess(e);if(a){c(a,r)}l()}$('[component="user/select/all"]').on("click",function(){$('.users-table [component="user/select/single"]').prop("checked",$(this).is(":checked"))});$(".manage-groups").on("click",function(){var i=o();if(!i.length){app.alertError("[[error:no-users-selected]]");return false}socket.emit("admin.user.loadGroups",i,function(i,o){if(i){return app.alertError(i)}a.render("admin/partials/manage_user_groups",o).then(function(a){var i=s.dialog({message:a,title:"[[admin/manage/users:manage-groups]]",onEscape:true});i.on("shown.bs.modal",function(){r.group(i.find(".group-search"),function(a,r){var t=$(a.target).attr("data-uid");n.put("/groups/"+r.item.group.slug+"/membership/"+t,undefined).then(()=>{r.item.group.nameEscaped=e.escape(r.item.group.displayName);app.parseAndTranslate("admin/partials/manage_user_groups",{users:[{groups:[r.item.group]}]},function(e){$("[data-uid="+t+"] .group-area").append(e.find(".group-area").html())})}).catch(app.alertError)})});i.on("click",".group-area a",function(){i.modal("hide")});i.on("click",".remove-group-icon",function(){var e=$(this).parents("[data-group-name]");var a=e.attr("data-group-name");var r=$(this).parents("[data-uid]").attr("data-uid");n.del("/groups/"+t(a)+"/membership/"+r).then(()=>{e.remove()}).catch(app.alertError);return false})})})});$(".ban-user").on("click",function(){var e=o();if(!e.length){app.alertError("[[error:no-users-selected]]");return false}s.confirm(e.length>1?"[[admin/manage/users:alerts.confirm-ban-multi]]":"[[admin/manage/users:alerts.confirm-ban]]",function(a){if(a){Promise.all(e.map(function(e){return n.put("/users/"+e+"/ban")})).then(()=>{h("[[admin/manage/users:alerts.ban-success]]",".ban",true)}).catch(app.alertError)}})});$(".ban-user-temporary").on("click",function(){var e=o();if(!e.length){app.alertError("[[error:no-users-selected]]");return false}a.render("admin/partials/temporary-ban",{}).then(function(a){s.dialog({className:"ban-modal",title:"[[user:ban_account]]",message:a,show:true,buttons:{close:{label:"[[global:close]]",className:"btn-link"},submit:{label:"[[admin/manage/users:alerts.button-ban-x, "+e.length+"]]",callback:function(){var a=$(".ban-modal form").serializeArray().reduce(function(e,a){e[a.name]=a.value;return e},{});var r=a.length>0?Date.now()+a.length*1e3*60*60*(parseInt(a.unit,10)?24:1):0;Promise.all(e.map(function(e){return n.put("/users/"+e+"/ban",{until:r,reason:a.reason})})).then(()=>{h("[[admin/manage/users:alerts.ban-success]]",".ban",true)}).catch(app.alertError)}}}})})});$(".unban-user").on("click",function(){var e=o();if(!e.length){app.alertError("[[error:no-users-selected]]");return false}Promise.all(e.map(function(e){return n.del("/users/"+e+"/ban")})).then(()=>{h("[[admin/manage/users:alerts.unban-success]]",".ban",false)})});$(".reset-lockout").on("click",function(){var e=o();if(!e.length){return}socket.emit("admin.user.resetLockouts",e,g("[[admin/manage/users:alerts.lockout-reset-success]]"))});$(".validate-email").on("click",function(){var e=o();if(!e.length){return}s.confirm("[[admin/manage/users:alerts.confirm-validate-email]]",function(a){if(!a){return}socket.emit("admin.user.validateEmail",e,function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[admin/manage/users:alerts.validate-email-success]]");c(".notvalidated",false);c(".validated",true);l()})})});$(".send-validation-email").on("click",function(){var e=o();if(!e.length){return}socket.emit("admin.user.sendValidationEmail",e,function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[notifications:email-confirm-sent]]")})});$(".password-reset-email").on("click",function(){var e=o();if(!e.length){return}s.confirm("[[admin/manage/users:alerts.password-reset-confirm]]",function(a){if(a){socket.emit("admin.user.sendPasswordResetEmail",e,g("[[notifications:email-confirm-sent]]"))}})});$(".force-password-reset").on("click",function(){var e=o();if(!e.length){return}s.confirm("[[admin/manage/users:alerts.confirm-force-password-reset]]",function(a){if(a){socket.emit("admin.user.forcePasswordReset",e,g("[[admin/manage/users:alerts.validate-force-password-reset-success]]"))}})});$(".delete-user").on("click",()=>{v("[[admin/manage/users:alerts.confirm-delete]]","/account")});$(".delete-user-content").on("click",()=>{v("[[admin/manage/users:alerts.confirm-delete-content]]","/content")});$(".delete-user-and-content").on("click",()=>{v("[[admin/manage/users:alerts.confirm-purge]]","")});function v(e,a){var r=o();if(!r.length){return}s.confirm(e,function(e){if(e){Promise.all(r.map(e=>n.del(`/users/${e}${a}`,{}).then(()=>{if(a!=="/content"){f(e)}}))).then(()=>{if(a!=="/content"){app.alertSuccess("[[admin/manage/users:alerts.delete-success]]")}else{app.alertSuccess("[[admin/manage/users:alerts.delete-content-success]]")}l();if(!$('.users-table [component="user/select/single"]').length){ajaxify.refresh()}}).catch(app.alertError)}})}function b(){$('[data-action="create"]').on("click",function(){a.render("admin/partials/create_user_modal",{}).then(function(e){var a=s.dialog({message:e,title:"[[admin/manage/users:alerts.create]]",onEscape:true,buttons:{cancel:{label:"[[admin/manage/users:alerts.button-cancel]]",className:"btn-link"},create:{label:"[[admin/manage/users:alerts.button-create]]",className:"btn-primary",callback:function(){y.call(this);return false}}}});a.on("shown.bs.modal",function(){a.find("#create-user-name").focus()})});return false})}function y(){var e=this;var a=document.getElementById("create-user-name").value;var r=document.getElementById("create-user-email").value;var t=document.getElementById("create-user-password").value;var s=document.getElementById("create-user-password-again").value;var i=$("#create-modal-error");if(t!==s){return i.translateHtml("[[admin/manage/users:alerts.error-x, [[admin/manage/users:alerts.error-passwords-different]]]]").removeClass("hide")}var o={username:a,email:r,password:t};n.post("/users",o).then(()=>{e.modal("hide");e.on("hidden.bs.modal",function(){ajaxify.refresh()});app.alertSuccess("[[admin/manage/users:alerts.create-success]]")}).catch(e=>i.translateHtml("[[admin/manage/users:alerts.error-x, "+e.status.message+"]]").removeClass("hidden"))}u();b();m();p();i.handle()};function u(){var e=0;function a(){$(".fa-spinner").removeClass("hidden");c({searchBy:$("#user-search-by").val(),query:$("#user-search").val(),page:1})}$("#user-search").on("keyup",function(){if(e!==0){clearTimeout(e);e=0}e=setTimeout(a,250)});$("#user-search-by").on("change",function(){a()})}function c(e){var a=utils.params();a.searchBy=e.searchBy;a.query=e.query;a.page=e.page;a.sortBy=a.sortBy||"lastonline";var r=decodeURIComponent($.param(a));$.get(config.relative_path+"/api/admin/manage/users?"+r,l).fail(function(e){if(e&&e.responseJSON&&e.responseJSON.error){app.alertError(e.responseJSON.error)}})}function l(r){a.render("partials/paginator",{pagination:r.pagination}).then(function(e){$(".pagination-container").replaceWith(e)});app.parseAndTranslate("admin/manage/users","users",r,function(a){$(".users-table tbody tr").remove();$(".users-table tbody").append(a);a.find(".timeago").timeago();$(".fa-spinner").addClass("hidden");if(!$("#user-search").val()){$("#user-found-notify").addClass("hidden");$("#user-notfound-notify").addClass("hidden");return}if(r&&r.users.length===0){$("#user-notfound-notify").translateHtml("[[admin/manage/users:search.not-found]]").removeClass("hidden");$("#user-found-notify").addClass("hidden")}else{$("#user-found-notify").translateHtml(e.compile("admin/manage/users:alerts.x-users-found",r.matchCount,r.timing)).removeClass("hidden");$("#user-notfound-notify").addClass("hidden")}})}function d(e){if($("#user-search").val()){e.query=$("#user-search").val();e.searchBy=$("#user-search-by").val()}else{delete e.query;delete e.searchBy}return decodeURIComponent($.param(e))}function m(){$(".users-table thead th").on("click",function(){var e=$(this);var a=e.attr("data-sort");if(!a){return}var r=utils.params();r.sortBy=a;if(ajaxify.data.sortBy===a){r.sortDirection=ajaxify.data.reverse?"asc":"desc"}else{r.sortDirection="desc"}var n=d(r);ajaxify.go("admin/manage/users?"+n)})}function f(){var e=[];$("#filter-by").find("[data-filter-by]").each(function(){if($(this).find(".fa-check").length){e.push($(this).attr("data-filter-by"))}});return e}function p(){var e=f();$("#filter-by").on("click","li",function(){var e=$(this);e.find("i").toggleClass("fa-check",!e.find("i").hasClass("fa-check"));return false});$("#filter-by").on("hidden.bs.dropdown",function(){var a=f();var r=a.length!==e.length;if(a.length===e.length){a.forEach(function(a,n){if(a!==e[n]){r=true}})}e=f();if(r){var n=utils.params();n.filters=a;var t=d(n);ajaxify.go("admin/manage/users?"+t)}})}return o});
//# sourceMappingURL=users.js.map